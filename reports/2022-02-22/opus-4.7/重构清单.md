# MindX 重构清单

> 基于 2022-02-22 Opus-4.7 评测报告，按优先级整理。

---

## P0 — 立即修复（安全与可靠性底线）

### 1. 移除日志中的凭证泄露

- **位置**: `internal/adapters/channels/whatsapp.go`, `facebook.go`
- **问题**: Token/Secret 被写入日志，生产环境存在凭证泄露风险
- **方向**: 删除或脱敏所有包含凭证的日志输出；引入日志脱敏中间件，对敏感字段自动 mask

### 2. .env 文件从版本控制移除

- **问题**: `.env` 已提交到仓库，敏感信息暴露在 Git 历史中
- **方向**: 将 `.env` 加入 `.gitignore`；提供 `.env.example` 作为模板；用 `git filter-branch` 或 BFG 清理历史记录

### 3. 替换 config.go 中的 log.Fatal()

- **位置**: `internal/config/config.go:15,20,25,30`
- **问题**: 配置加载失败直接终止进程，调用方无法处理错误
- **方向**: 改为返回 `error`，由调用方决定是否退出；使用项目自定义错误包 `internal/errors/` 包装错误

### 4. LLM 调用添加重试机制

- **位置**: `internal/usecase/brain/thinking.go:183`
- **问题**: 单次调用失败即终止，网络抖动直接导致请求失败，这是最严重的技术缺陷
- **方向**: 实现指数退避重试（建议 3 次，间隔 1s/2s/4s）；区分可重试错误（网络超时、5xx）和不可重试错误（4xx、上下文溢出）；考虑引入断路器模式防止雪崩

---

## P1 — 高优先级（架构与性能）

### 5. 修复分层违规：Store 接口位置

- **位置**: `internal/infrastructure/persistence/` 中定义的 `Store` 接口
- **问题**: usecase 层反向依赖 infrastructure 层，违反依赖倒置原则（共 3 处）
- **方向**: 将 `Store` 接口移至 `internal/core/` 包；infrastructure 层实现该接口；确保依赖方向始终为 adapters → usecase → core ← infrastructure

### 6. 向量搜索引入索引结构

- **位置**: `internal/infrastructure/embedding/`
- **问题**: 当前为 O(n) 全表扫描，万级向量后延迟不可接受
- **方向**: 引入 HNSW（Hierarchical Navigable Small World）索引；可考虑集成 `github.com/viterin/vek` 做 SIMD 加速的向量运算；添加相似度阈值过滤，避免返回低质量结果

### 7. Token 管理精确化

- **位置**: `internal/usecase/brain/thinking.go:96`, `token_budget.go`
- **问题**: `availableTokens` 未扣除系统提示和参考资料开销，可能导致上下文溢出
- **方向**: 引入 tokenizer（如 `tiktoken-go`）精确计算系统提示 + 参考资料的 Token 数；从可用额度中扣除后再计算历史轮数；添加单条消息 Token 计数替代平均值估算

### 8. context.Context 贯穿调用链

- **位置**: 全局，重点在 `thinking.go`, `tool_caller.go`, `brain.go`
- **问题**: Goroutine 生命周期缺少 Context 传播，无法实现超时控制和优雅取消
- **方向**: 所有公开方法签名添加 `ctx context.Context` 作为第一个参数；用 `context.WithTimeout` 替代硬编码超时；在 `Shutdown()` 中通过 cancel 统一终止所有 goroutine

### 9. 渠道层添加断路器与速率限制

- **位置**: `internal/adapters/channels/` 全部 14 个渠道
- **问题**: 无断路器、无指数退避重试、无速率限制、无健康检查
- **方向**: 引入断路器库（如 `sony/gobreaker`）；实现统一的速率限制中间件；添加渠道健康检查接口和自动恢复逻辑

### 10. 补充关键模块测试

- **问题**: `infrastructure/persistence`、`config`、`adapters/http`、`usecase/training`、`usecase/cron`、`usecase/embedding` 均零测试
- **方向**: 优先补充 persistence 层测试（数据正确性是底线）；config 层测试（覆盖加载失败、格式错误、默认值等场景）；使用 `MINDX_WORKSPACE=$(PWD)/.test` 隔离测试数据

---

## P2 — 中优先级（工程规范与代码质量）

### 11. 抽取渠道公共逻辑

- **位置**: `internal/adapters/channels/` 14 个渠道实现
- **问题**: HTTP 服务器启停、Token 刷新、消息发送构建等大量重复代码
- **方向**: 抽取 `BaseWebhookChannel` 基础结构，封装通用的 HTTP 服务器生命周期、Token 刷新循环、消息发送模板；各渠道只需实现差异化的消息解析和格式转换

### 12. 统一错误处理

- **位置**: 全局，重点在 `internal/usecase/training/trainer.go`（20+ 处 `fmt.Errorf`）
- **问题**: 自定义错误包已定义但使用率低，大量代码用 `fmt.Errorf`，部分错误被静默忽略
- **方向**: 全面替换 `fmt.Errorf` 为 `errors.New()` / `errors.Wrap()`；消除 `_ = c.Stop()` 等静默忽略；统一错误分类（CONFIG、NETWORK、STORAGE、MODEL 等）

### 13. 降低 BionicBrain 构造函数耦合

- **位置**: `internal/usecase/brain/brain.go:20-38`
- **问题**: 构造函数 11 个参数，耦合度高
- **方向**: 引入 Options 模式（`BrainOption func(*BionicBrain)`）；将相关参数分组为配置结构体；拆分大接口为小接口（`Thinker`、`ToolUser`、`TokenCalculator`）

### 14. 可观测性基础设施

- **问题**: 仅有基础日志，无 Prometheus 指标、无 trace ID、无健康检查端点
- **方向**: 添加 `/health` 和 `/ready` 端点；集成 Prometheus client 暴露关键指标（LLM 调用延迟/成功率、Token 消耗、活跃会话数、渠道状态）；为请求链路添加 trace ID 贯穿日志

### 15. WebSocket 加固

- **位置**: `internal/adapters/http/`
- **问题**: 无心跳、无认证、无连接数限制、CORS 检查可能过于宽松
- **方向**: 实现 ping/pong 心跳机制（建议 30s 间隔）；添加连接认证（Token 或 Session）；限制最大连接数；收紧 CORS 策略

### 16. 记忆系统增强

- **位置**: `internal/usecase/memory/`
- **问题**: 缺少去重、衰减和整理机制，与 README 宣传的"智能整理"不符
- **方向**: 实现记忆去重（基于语义相似度合并）；引入时间衰减因子（越久远的记忆权重越低）；定期整理合并碎片化记忆

### 17. Prompt 工程改进

- **位置**: `internal/core/prompt_builder.go`, `brain.go`
- **问题**: 无 Chain-of-Thought、无 Few-shot 示例、无版本管理；左脑 prompt 承载过多职责
- **方向**: 将左脑 prompt 拆分为专注的子任务（意图分析、定时检测分开）；添加 Few-shot 示例提升输出格式稳定性；引入 prompt 模板文件 + 版本号管理

---

## P3 — 低优先级（体验优化与长期演进）

### 18. 前端 TypeScript strict 模式

- **位置**: `dashboard/tsconfig.json`
- **问题**: `strict` 关闭，`noUnusedLocals` 和 `noUnusedParameters` 均为 false
- **方向**: 分步开启 strict 选项（先 `strictNullChecks`，再 `strict: true`）；清理 tsconfig 中的重复配置键

### 19. 前端大组件拆分

- **位置**: `dashboard/src/` 中 `Skills.tsx`（23.5 KB）、`Channels.tsx`（19.6 KB）
- **方向**: 按功能拆分为子组件；添加错误边界（Error Boundary）；引入 URL 路由（React Router）替代 Tab 切换

### 20. TUI 体验改进

- **位置**: `internal/adapters/cli/tui.go`
- **问题**: WebSocket 断连无重连、思考步骤硬编码中文、无空消息校验、无输入历史
- **方向**: 实现 WebSocket 自动重连（指数退避）；思考步骤文案走 i18n；添加空消息校验；支持上下键翻阅输入历史

### 21. BadgerDB 持久化层加固

- **位置**: `internal/infrastructure/persistence/`
- **问题**: 无 TTL、无压缩、无备份、无事务保证
- **方向**: 为临时数据设置 TTL 自动过期；启用 BadgerDB 值压缩；实现定期备份机制；关键操作使用事务保证一致性

### 22. 配置 CI/CD 流水线

- **问题**: 无 GitHub Actions 或其他 CI/CD 配置；无 `.golangci.yml` linter 配置
- **方向**: 添加 GitHub Actions workflow（lint → test → build）；配置 `golangci-lint` 统一代码风格检查；添加前端 CI（lint + type-check）

### 23. 钉钉渠道安全加固

- **位置**: `internal/adapters/channels/dingtalk.go`
- **问题**: 无消息时间戳验证，存在重放攻击风险
- **方向**: 校验消息时间戳，拒绝超过合理窗口（如 5 分钟）的消息；验证签名防止伪造

### 24. 训练流程质量控制

- **位置**: `training/`, `internal/usecase/training/`
- **问题**: 缺少 early stopping、学习率调度和数据质量控制
- **方向**: 添加 early stopping 防止过拟合；引入学习率调度器（cosine/linear）；训练前进行数据质量检查（去重、格式校验、长度过滤）

---

## 总览

| 优先级 | 数量 | 核心主题 |
|--------|------|---------|
| P0 | 4 | 安全漏洞修复、LLM 调用可靠性 |
| P1 | 6 | 架构违规修正、性能瓶颈、测试补充 |
| P2 | 7 | 代码重复消除、错误处理统一、可观测性 |
| P3 | 7 | 前端质量、TUI 体验、CI/CD、持久化加固 |
